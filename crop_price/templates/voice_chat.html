<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Crop Crystalline Voice Assistant</title>
  <style>
    body { font-family: Arial, sans-serif; padding:20px; }
    #messages { margin-top:20px; max-width:720px; }
    .user { color:blue; }
    .bot { color:rgb(123, 175, 123); }
  </style>
</head>
<body>
  <h2>ðŸŒ± Crop Crystalline â€” Voice Assistant</h2>
  <div id="messages"></div>

<script>

(function() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("Your browser doesn't support speech recognition. Please use Chrome or Edge.");
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = "en-US";

  const messages = document.getElementById("messages");
  let lastBotReply = "";
  let botSpeaking = false;

  function addMessage(role, text) {
    const div = document.createElement("div");
    div.className = role;
    div.innerHTML = `<b>${role === 'user' ? 'You' : 'Bot'}:</b> ${text}`;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  async function askBot(text) {
    text = text.trim();
    if (!text) return;

    addMessage('user', text);

    // Ignore if text matches bot's last reply
    if (text.toLowerCase() === lastBotReply.toLowerCase()) {
      console.log("Ignored bot echo:", text);
      return;
    }

    try {
      const resp = await fetch(`/ask/?message=${encodeURIComponent(text)}`);
      const data = await resp.json();

      if (data.reply) {
        lastBotReply = data.reply;
        addMessage('bot', data.reply);
        speak(data.reply);
      } else {
        addMessage('bot', "Error: " + data.error);
        startRecognition();
      }
    } catch (e) {
      addMessage('bot', "Server error: " + e.message);
      startRecognition();
    }
  }

  function speak(text) {
    botSpeaking = true;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "en-US";

    try { recognition.stop(); } catch(e) {}

    utterance.onend = () => {
      botSpeaking = false;
      console.log("Bot finished speaking, restarting recognition...");
      setTimeout(startRecognition, 500);
    };

    speechSynthesis.speak(utterance);
  }

  function startRecognition() {
    if (!botSpeaking) {
      try {
        recognition.start();
      } catch (e) {
        console.warn("Recognition start failed:", e);
      }
    }
  }

  recognition.onresult = event => {
    if (botSpeaking) {
      // Ignore all transcripts while bot is speaking
      console.log("Ignored transcript while bot speaking");
      return;
    }

    const transcript = Array.from(event.results)
      .map(r => r[0].transcript)
      .join(" ")
      .trim();

    // Extra safety: ignore if transcript matches bot reply
    if (transcript.toLowerCase() === lastBotReply.toLowerCase()) {
      console.log("Ignored bot echo in transcript:", transcript);
      return;
    }

    askBot(transcript);
  };

  recognition.onend = () => {
    if (!botSpeaking) {
      startRecognition();
    }
  };

  recognition.onerror = event => {
    console.warn("SpeechRecognition error:", event.error);
    if (!botSpeaking) setTimeout(startRecognition, 1000);
  };

  startRecognition();
})();

</script>
</body>
</html>
